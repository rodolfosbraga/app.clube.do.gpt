<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8">
  <title>Redefinir senha | Clube do GPT</title>
  <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&display=swap" rel="stylesheet">
  <style>
    html, body {
      height: 100%;
      margin: 0;
      padding: 0;
    }
    body {
      min-height: 100vh;
      min-width: 100vw;
      background: url('background-login.jpeg') no-repeat center center fixed;
      background-size: cover;
      font-family: 'Cinzel', serif;
      color: #fff;
      display: flex;
      justify-content: center;
      align-items: center;
      position: relative;
    }
    .overlay {
      position: absolute;
      inset: 0;
      background: linear-gradient(120deg, #101828cc 40%, #22345599 100%);
      backdrop-filter: blur(2px);
      z-index: 1;
    }
    .reset-center {
      position: relative;
      z-index: 2;
      width: 100vw;
      height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .reset-container {
      background: rgba(15,25,40,0.52);
      padding: 32px 36px;
      border-radius: 20px;
      box-shadow: 0 8px 32px 0 rgba(13,21,38,0.22);
      min-width: 310px;
      max-width: 97vw;
      text-align: center;
      margin: 0 auto;
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    .reset-container h2 {
      color: #03b0ec;
      margin-bottom: 18px;
      font-size: 2.1rem;
      letter-spacing: 0.5px;
      font-weight: 700;
      text-shadow: 0 2px 10px #14274466;
    }
    .reset-container input[type="password"] {
      width: 87%;
      padding: 13px 10px;
      border-radius: 8px;
      border: 1.3px solid #2bb5f9cc;
      margin-bottom: 18px;
      font-size: 1.12rem;
      font-family: 'Cinzel', serif;
      background: rgba(23, 36, 61, 0.67);
      color: #e6f3fb;
    }
    .reset-container input[type="password"]::placeholder {
      color: #a0bcd6;
    }
    .reset-container button {
      padding: 12px 34px;
      background: #03b0ec;
      color: #fff;
      border: none;
      border-radius: 9px;
      font-size: 1.09rem;
      font-family: 'Cinzel', serif;
      font-weight: 600;
      cursor: pointer;
      transition: background 0.18s;
      box-shadow: 0 2px 12px #03b0ec11;
    }
    .reset-container button:hover {
      background: #0291c5;
    }
    .toast {
      background: #04b1f0;
      color: #fff;
      border-radius: 7px;
      padding: 13px 24px;
      margin: 20px auto 0 auto;
      display: none;
      max-width: 85vw;
      font-family: 'Cinzel', serif;
      font-weight: 500;
      font-size: 1.01rem;
      letter-spacing: 0.03em;
      box-shadow: 0 3px 18px #011f2d22;
    }
    .toast.show {
      display: block;
      animation: fadein 0.7s;
    }
    @keyframes fadein {
      from { opacity: 0; }
      to { opacity: 1; }
    }
    @media (max-width: 600px) {
      .reset-container {
        min-width: 0;
        width: 97vw;
        padding: 14px 4vw;
      }
      .reset-container h2 {
        font-size: 1.28rem;
      }
      .reset-container input[type="password"] {
        font-size: 0.97rem;
      }
      .reset-container button {
        font-size: 0.97rem;
        padding: 11px 16px;
      }
    }
  </style>
</head>
<body>
  <div class="overlay"></div>
  <div class="reset-center">
    <div class="reset-container">
      <h2>Redefinir senha</h2>
      <form id="resetForm" autocomplete="off">
        <input type="password" id="senha1" placeholder="Nova senha" required autocomplete="new-password"><br>
        <input type="password" id="senha2" placeholder="Confirme a nova senha" required autocomplete="new-password"><br>
        <button type="submit">Redefinir</button>
      </form>
      <div id="toast" class="toast"></div>
    </div>
  </div>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.42.5/dist/umd/supabase.min.js"></script>
  <script>
    // 1. Supabase config
    const supabase = window.supabase.createClient(
      'https://fouqnyydrhxgadnxjtds.supabase.co',
      'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZvdXFueXlkcmh4Z2FkbnhqdGRzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTI0NjQyNDUsImV4cCI6MjA2ODA0MDI0NX0.JH2SFA-6itPBy_Vdnqm9wCmIw7m3BPHRlZkfcgaP-is'
    );

    // 2. Toast flutuante
    function showToast(msg) {
      var t = document.getElementById('toast');
      t.textContent = msg;
      t.className = 'toast show';
      setTimeout(()=>{t.className='toast'}, 3500);
    }

    // 3. Handler de sessão de recovery (OBRIGATÓRIO para funcionar com Supabase!)
    const params = new URLSearchParams(window.location.search);
    const type = params.get('type');
    const access_token = params.get('access_token') || params.get('token');
    if (type === 'recovery' && access_token) {
      supabase.auth.exchangeCodeForSession(access_token)
        .then(({ data, error }) => {
          if (error) {
            showToast('Erro ao validar o link de redefinição.');
          }
        });
    }

    // 4. Handler do formulário
    document.getElementById('resetForm').onsubmit = async function(e) {
      e.preventDefault();
      const senha1 = document.getElementById('senha1').value.trim();
      const senha2 = document.getElementById('senha2').value.trim();
      if (!senha1 || !senha2) {
        showToast('Preencha a nova senha nos dois campos.');
        return;
      }
      if (senha1 !== senha2) {
        showToast('As senhas não coincidem.');
        return;
      }
      // Atualiza a senha usando o Supabase (usuário já autenticado via token recovery)
      const { data, error } = await supabase.auth.updateUser({ password: senha1 });
      if (error) {
        showToast('Erro ao redefinir senha: ' + error.message);
        return;
      }
      showToast('Senha redefinida com sucesso! Faça login novamente.');
      setTimeout(()=>{ window.location = 'index.html'; }, 1900);
    };
  </script>
</body>
</html>
