<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Clube do GPT – Login</title>
  <!-- Fonte Cinzel -->
  <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&display=swap" rel="stylesheet" />
  <style>
    :root {
      --azul-glow: #03b0ec;
      --btn-main: #04b1f0;
      --btn-hover: #0091c4;
      --input-bg: rgba(23,36,61,0.67);
      --input-text: #e6f3fb;
      --input-placeholder: #a0bcd6;
      --glass: rgba(15,25,40,0.44);
      --white: #fff;
    }
    * { box-sizing: border-box; margin:0; padding:0; }
    html, body {
      width:100%; height:100%;
      font-family:'Cinzel', serif;
      background: url('background-login.jpeg') no-repeat center/cover fixed;
    }
    .main-center {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      min-height:100vh;
      padding: 1rem;
    }
    .login-container {
      width:100%; max-width:420px;
      background: var(--glass);
      backdrop-filter: blur(14px);
      border-radius:20px;
      padding:2.5rem 2rem 1.5rem;
      box-shadow:0 8px 32px rgba(13,21,38,0.22);
      display:flex; flex-direction:column; align-items:center;
    }
    .logo-holder {
      width:30%; min-width:110px; max-width:150px;
      aspect-ratio:1;
      margin-bottom:1.5rem;
      background:rgba(255,255,255,0.08);
      border: none;
      display:flex; align-items:center; justify-content:center;
      box-shadow:0 2px 16px rgba(10,40,70,0.13);
    }
    .logo-holder img { width:80%; height:80%; object-fit:contain; border: none; }
    .login-title { font-size:2rem; color:var(--white); margin-bottom:.5rem; text-shadow:0 2px 10px rgba(20,39,68,.4); }
    .login-subtitle { color:#c8e8fc; font-size:1rem; text-align:center; margin-bottom:1.5rem; }
    .login-form { width:100%; display:flex; flex-direction:column; gap:1rem; }
    .login-input {
      padding: .8rem 1rem; border-radius:9px; border:1.5px solid rgba(43,181,249,.6);
      background:var(--input-bg); color:var(--input-text);
      font-size:1rem; transition:.2s; outline:none;
    }
    .login-input:focus { border-color: var(--azul-glow); background: rgba(23,36,61,.82); }
    .login-input::placeholder { color:var(--input-placeholder); opacity:1; }
    .login-links { width:100%; text-align:right; margin-top:.2rem; }
    .login-links a {
      color:#c8e8fc; text-decoration:none; font-size:.95rem; opacity:.85;
      transition:.2s; cursor:pointer;
    }
    .login-links a:hover { text-decoration:underline; opacity:1; }

    .btns-stack {
      width:100%; display:flex; flex-direction:column; gap:1rem; margin-top:1rem;
    }
    .login-btn,
    .firstaccess-btn,
    .signup-btn,
    .google-btn {
      width:100%; padding:.8rem 0; border-radius:9px;
      font-size:1.05rem; font-weight:600; letter-spacing:.3px;
      cursor:pointer; display:flex; align-items:center; justify-content:center;
      transition:.2s;
    }

    .login-btn {
      background: var(--btn-main); border:1.5px solid var(--btn-main); color:#fff;
      box-shadow:0 2px 12px rgba(3,176,236,.1);
    }
    .login-btn:hover { background:var(--btn-hover); }

    .google-btn {
      background:#000; border:1.5px solid #000; color:#fff;
    }
    .google-btn img.google-icon {
      width:20px; height:20px; margin-right: 8px;
      vertical-align: middle;
    }
    .google-btn:hover { background:#111; }

    .firstaccess-btn {
      background:#fff; border:1.5px solid var(--btn-main); color:var(--btn-main);
    }
    .firstaccess-btn:hover { background:var(--btn-main); color:#fff; }

    .signup-btn {
      background:transparent; border:1.5px solid rgba(43,181,249,0.8); color:var(--btn-main);
    }
    .signup-btn:hover { background:rgba(200,232,252,.3); }

    .links-footer {
      margin-top:1.5rem; text-align:center; font-size:.95rem;
    }
    .links-footer a {
      color:#fff; margin:0 .5rem; text-decoration:underline; font-weight:500;
    }

    .text-footer {
      margin-top:.5rem; font-size:.82rem; color:#fff; text-align:center;
    }

    /* Toast */
    #toast-gpt {
      position:fixed; bottom:30px; left:50%; transform:translateX(-50%);
      background:var(--btn-main); color:#fff; padding:1rem 1.5rem;
      border-radius:8px; opacity:0; transition:opacity .3s;
      z-index:999;
    }
    #toast-gpt.show { opacity:1; }
  </style>
</head>
<body>
  <div class="main-center">
    <form class="login-container" id="loginForm">
      <div class="logo-holder">
        <img src="logo-placeholder.png" alt="Logo Clube do GPT">
      </div>
      <div class="login-title">Clube do <span style="color:#04b1f0">GPT</span></div>
      <div class="login-subtitle">
        O seu clube de inteligência artificial: GPTs que realmente ajudam no seu dia a dia.
      </div>

      <div class="login-form">
        <input type="email" class="login-input" placeholder="Seu e-mail" required>
        <input type="password" class="login-input" placeholder="Digite sua senha" required>
      </div>
      <div class="login-links">
        <a href="#" id="forgotPwdLink">Esqueceu a senha?</a>
      </div>

      <div class="btns-stack">
        <button type="submit" class="login-btn">Entrar</button>

        <button type="button" class="google-btn" id="googleLoginBtn">
          <img src="logo-google.svg" alt="G" class="google-icon">
          Entrar com Google
        </button>

        <button type="button" class="firstaccess-btn" id="firstAccessBtn">
          Primeiro acesso
        </button>

        <button type="button" class="signup-btn" id="signupBtn">
          Quero ser membro
        </button>
      </div>
    </form>

    <div class="links-footer">
      <a href="privacidade.html" target="_blank">Política de Privacidade</a>
      |
      <a href="termos.html" target="_blank">Termos de Uso</a>
    </div>
    <div class="text-footer">
      Todos os direitos reservados à Rodolfo da Silva Braga
    </div>
  </div>

  <div id="toast-gpt"></div>

  <!-- Supabase JS -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>
  <script>
    // 1) Configurações Supabase
    const SUPABASE_URL = 'https://fouqnyydrhxgadnxjtds.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZvdXFueXlkcmh4Z2FkbnhqdGRzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTI0NjQyNDUsImV4cCI6MjA2ODA0MDI0NX0.JH2SFA-6itPBy_Vdnqm9wCmIw7m3BPHRlZkfcgaP-is'; 
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // ① ao carregar a página, já tenta pegar a sessão existente
(async () => {
  const { data: { session } } = await supabase.auth.getSession();
  await handleSession(session);
})();
    // ② também ainda escuta onAuthStateChange (por exemplo, após completar o OAuth)
supabase.auth.onAuthStateChange((event, session) => {
  handleSession(session);
});
   
    // checa se session existe e faz a validação de membro
    async function handleSession(session) {
      if (!session) return;
    const email = session.user.email;
    const { data: member, error } = await supabase
    .from('members')
    .select('plan_status')
    .eq('email', email)
    .maybeSingle();
      if (!error && member?.plan_status === 'ativo') {
    window.location.href = 'app.html';
  }   else {
    window.location.href = 'convite.html';
  }
}
    
    // 2) Função de Toast
    function showToast(msg, time = 5000) {
      const t = document.getElementById('toast-gpt');
      t.textContent = msg;
      t.classList.add('show');
      setTimeout(() => t.classList.remove('show'), time);
    }

    // 3) Redirecionamento do Magic Link (recovery & signup)
    //    permite ao reset-password.html capturar o token e trocar senha
    const redirectTo = `${window.location.origin}/reset-password.html`;

    // 4) Listen em mudanças de auth (e também login via Google)
    supabase.auth.onAuthStateChange(async (event, session) => {
      if (event === 'SIGNED_IN' && session) {
        const email = session.user.email;
        // verifica se existe member ativo
        const { data: member, error } = await supabase
          .from('members')
          .select('plan_status')
          .eq('email', email)
          .maybeSingle();

        if (!error && member && member.plan_status === 'ativo') {
          // membro ativo
          window.location.href = 'app.html';
        } else {
          // não-membro
          window.location.href = 'convite.html';
        }
      }
    });

    // 5) Login “tradicional”
    document.getElementById('loginForm').addEventListener('submit', async e => {
      e.preventDefault();
      const email = e.target.querySelector('input[type="email"]').value.trim();
      const password = e.target.querySelector('input[type="password"]').value;
      if (!email || !password) {
        showToast('Preencha e-mail e senha.');
        return;
      }
      const { error } = await supabase.auth.signInWithPassword({ email, password });
      if (error) {
        showToast('E-mail ou senha inválidos.');
      }
      // a verificação de membership e redirecionamento vão ocorrer no onAuthStateChange acima
    });

    // 6) “Esqueceu a senha?”
    document.getElementById('forgotPwdLink').addEventListener('click', async e => {
      e.preventDefault();
      const email = prompt('Informe seu e-mail cadastrado:');
      if (!email) return;
      const { error } = await supabase.auth.signInWithOtp({
        email: email.trim(),
        options: { redirectTo }
      });
      if (error) showToast('Erro ao enviar link de redefinição.');
      else       showToast('Link de redefinição enviado (se e-mail cadastrado).');
    });

    // 7) “Primeiro acesso” → Magic Link para criar senha
    document.getElementById('firstAccessBtn').addEventListener('click', async () => {
      const email = prompt('Digite o e-mail usado na compra:');
      if (!email) return;
      const { error } = await supabase.auth.signInWithOtp({
        email: email.trim(),
        options: { redirectTo }
      });
      if (error) showToast('Erro ao enviar link de criação de senha.');
      else       showToast('Link de criação de senha enviado!');
    });

    // 8) “Quero ser membro”
    document.getElementById('signupBtn').addEventListener('click', () => {
      window.open('https://rodolfosbraga.github.io/clube-do-gpt/', '_blank');
    });

    // 9) Login via Google
    document.getElementById('googleLoginBtn').addEventListener('click', () => {
      supabase.auth.signInWithOAuth({
        provider: 'google',
        options: { redirectTo: 'https://rodolfosbraga.github.io/app.clube.do.gpt/index.html' }
      });
    });
  </script>
</body>
</html>
