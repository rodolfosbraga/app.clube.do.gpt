<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Clube dos GPTs</title>

  <!-- Estilos -->
  <link rel="stylesheet" href="css/styles.css" />
  <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;600;700&display=swap" rel="stylesheet">
  
</head>
<body>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.45.4/dist/umd/supabase.js"></script>
<!-- Supabase -->
<script>
  const SUPABASE_URL       = 'https://fouqnyydrhxgadnxjtds.supabase.co';
  const SUPABASE_ANON_KEY  = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZvdXFueXlkcmh4Z2FkbnhqdGRzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTI0NjQyNDUsImV4cCI6MjA2ODA0MDI0NX0.JH2SFA-6itPBy_Vdnqm9wCmIw7m3BPHRlZkfcgaP-is'; // mesma do index

  // URLs usadas nos redirecionamentos
  const LOGIN_URL = 'index.html';  // p√°gina de login
  const APP_URL   = 'app.html';    // esta p√°gina
  const HERE      = location.pathname.split('/').pop().toLowerCase();

  // Cria UMA vez (evita "Multiple GoTrueClient...")
  window.supabaseClient ??= window.supabase.createClient(
    SUPABASE_URL,
    SUPABASE_ANON_KEY,
    { auth: { storageKey: 'clube-gpts-auth' } }
  );
  // ‚úÖ Alias para qualquer trecho que usa `supabase`
  const supabase = window.supabaseClient;

  // Evita redirecionamentos em cascata
  function safeReplace(url) {
    if (sessionStorage.getItem('redir-lock') === '1') return;
    sessionStorage.setItem('redir-lock', '1');
    window.location.replace(url);
  }

  (async function initAuth(){
    try {
      const { data: { session } } = await supabase.auth.getSession();

      // Sem sess√£o: s√≥ redireciona se N√ÉO estiver no login
      if (!session) {
        if (HERE !== LOGIN_URL) safeReplace(LOGIN_URL);
        return;
      }

      // Com sess√£o: exp√µe user_id para o app.js
      document.documentElement.dataset.userId = session.user.id;
      sessionStorage.removeItem('redir-lock');

      // (Opcional) validar se √© membro ativo (comente se n√£o usar)
      try {
        const email = (session.user.email || '').trim().toLowerCase();
        const { data: member } = await supabase
          .from('members')
          .select('plan_status')
          .ilike('email', email)
          .maybeSingle();

        if (!member || member.plan_status !== 'ativo') {
          await supabase.auth.signOut();
          alert('Acesso restrito a membros ativos.');
          safeReplace(LOGIN_URL);
          return;
        }
      } catch (e) {
        console.warn('Membership check:', e);
        // Se quiser bloquear quando falhar:
        // safeReplace(LOGIN_URL); return;
      }
    } catch (err) {
      console.error('Auth bootstrap failed:', err);
      safeReplace(LOGIN_URL);
    }
  })();

  // üîì Logout global (chamado pelo app.js)
  window.appLogout = async function () {
    try { await supabase.auth.signOut(); } catch (_) {}
    localStorage.clear(); sessionStorage.clear();
    safeReplace(LOGIN_URL);
  };
</script>
    
  <!-- SIDEBAR -->
  <aside id="sidebar" class="sidebar">
    <ul class="menu">
      <li data-section="gpts">
        <span class="icon">ü§ñ</span>
        <span class="label">GPTs</span>
      </li>
      <li data-section="favoritos">
        <span class="icon">üíé</span>
        <span class="label">Favoritos</span>
      </li>
      <li data-section="Importar link de GPT">
        <span class="icon">üíæ</span>
        <span class="label">Adicione o seu GPT</span>
      </li>
      <li data-section="sugestoes">
        <span class="icon">üí≠</span>
        <span class="label">Sugest√µes</span>
      </li>
      <li data-section="config">
        <span class="icon">‚öôÔ∏è</span>
        <span class="label">Configura√ß√µes</span>
      </li>
      <li data-section="perfil">
        <span class="icon">üë§</span>
        <span class="label">Perfil</span>
      </li>
      <li data-section="suporte">
        <span class="icon">üë©üèª‚Äçüîß</span>
        <span class="label">Suporte</span>
      </li>
      <li data-section="clube">
        <span class="icon">üèõÔ∏è</span>
        <span class="label">CLUBE</span>
      </li>
      <li data-section="sair">
        <span class="icon">üö™</span>
        <span class="label">Sair</span>
      </li>
    </ul>
  </aside>

  <!-- BOT√ÉO DE COLAPSO -->
  <button id="collapseBtn" class="collapse-btn" aria-label="Toggle sidebar">‚Äπ</button>

  <!-- HEADER FIXO -->
  <header class="topbar">
    <img src="logo-placeholder.png" alt="Logo do Clube" class="header-logo" />
    <div class="titles">
      <h1 class="logo">Clube dos GPTs</h1>
      <p class="tagline">Sua cole√ß√£o premium de assistentes de IA</p>
    </div>
  </header>

  <!-- BARRA DE BUSCA + TABS FIXA -->
  <div id="searchTabs" class="search-tabs">
    <div class="inner">
      <h2 id="sectionTitle" class="section-title">Categoria</h2>

      <div class="search-bar">
        <div class="input-wrapper">
          <input id="searchInput" type="text" placeholder="Pesquise um GPT..." />
          <button id="searchBtn" class="search-icon" aria-label="Buscar" data-action="search">üîç</button>
        </div>
        <button id="favoritesBtn" data-action="viewFavorites">Favoritos</button>
           </div>

      <div id="categoryTabs" class="tabs"></div>
    </div>
  </div>

  <!-- CONTE√öDO PRINCIPAL -->
  <div class="wrapper">
    <main class="main">
      <!-- √Årea din√¢mica padr√£o (cards GPTs / Favoritos) -->
      <div id="content"></div>

      <!-- SUGEST√ïES (novo form com vari√°veis p/ Supabase) -->
      <section id="suggestionsSection" hidden>
        <div class="inner">
          <h3>Enviar Sugest√µes</h3>
          <form id="suggestionForm"
                data-table="suggestions"
                data-success-toast="Obrigado pela sugest√£o! üôå"
                data-success-timeout="5000">
            <input type="hidden" name="user_id" value="" data-col="user_id" />

            <div class="form-group">
              <label for="sugType">Tipo</label>
              <select id="sugType" name="type" data-col="type" required>
                <option value="gpt">Novo GPT</option>
                <option value="melhoria">Melhoria</option>
              </select>
            </div>

            <div class="form-group">
              <label for="sugTitle">T√≠tulo</label>
              <input id="sugTitle" name="title" data-col="title" type="text" placeholder="T√≠tulo da sugest√£o" required />
            </div>

            <div class="form-group">
              <label for="sugLink">Link (opcional)</label>
              <input id="sugLink" name="link" data-col="link" type="url" placeholder="https://..." />
            </div>

            <div class="form-group">
              <label for="sugCategory">Categoria (opcional)</label>
              <input id="sugCategory" name="category" data-col="category" type="text" placeholder="Ex.: Marketing, C√≥digo..." />
            </div>

            <div class="form-group">
              <label for="sugDesc">Descri√ß√£o</label>
              <textarea id="sugDesc" name="description" data-col="description" rows="4" placeholder="Conte sua ideia..." required></textarea>
            </div>

            <div class="form-group">
              <label for="sugFiles">Arquivos (opcional)</label>
              <input id="sugFiles" name="files" type="file" multiple />
            </div>

            <button type="submit" data-action="submitSuggestion">Enviar sugest√£o</button>
          </form>
        </div>
      </section>

      <!-- CONFIGURA√á√ïES -->
      <section id="configSection" hidden>
        <div class="inner">
          <h3>Configura√ß√µes</h3>
          <div class="form-group">
            <label for="darkModeToggle">Tema escuro</label>
            <input type="checkbox" id="darkModeToggle" name="darkmode" data-col="darkmode" />
          </div>
          <div class="form-group">
            <label for="prefCategories">Prefer√™ncias de categorias</label>
            <input id="prefCategories" name="pref_categories" data-col="pref_categories" type="text" placeholder="Ex.: IA, Marketing, Vendas" />
          </div>
          <div class="form-group">
            <label>Seu plano</label>
            <div id="planInfo" data-col="plan">Plano: ‚Ä¢ Renova em: ‚Äî</div>
          </div>
        </div>
      </section>

      <!-- PERFIL (antes ‚ÄúCadastro‚Äù) -->
      <section id="profileSection" hidden>
        <div class="inner">
          <h3>Perfil</h3>
          <form id="profileForm" data-table="profiles">
            <input type="hidden" name="user_id" value="" data-col="user_id" />

            <div class="form-group">
              <label for="profileName">Nome</label>
              <input id="profileName" name="name" data-col="name" type="text" placeholder="Seu nome" />
            </div>
            <div class="form-group">
              <label for="profileUsername">Usu√°rio</label>
              <input id="profileUsername" name="username" data-col="username" type="text" placeholder="@usuario" />
            </div>
            <div class="form-group">
              <label for="profileEmail">E-mail</label>
              <input id="profileEmail" name="email" data-col="email" type="email" placeholder="voce@exemplo.com" readonly />
            </div>
            <div class="form-group">
              <label for="profileBio">Apresenta√ß√£o</label>
              <textarea id="profileBio" name="bio" data-col="bio" rows="3" placeholder="Conte um pouco sobre voc√™"></textarea>
            </div>
            <div class="form-group">
              <label for="profilePrefs">Prefer√™ncias</label>
              <input id="profilePrefs" name="preferences" data-col="preferences" type="text" placeholder="Ex.: IA, SEO, Finan√ßas" />
            </div>

            <button type="submit" data-action="saveProfile">Salvar perfil</button>
          </form>
        </div>
      </section>

      <!-- SUPORTE (Typebot) -->
      <section id="supportSection" hidden>
        <div class="inner">
          <h3>Suporte (em desenvolvimento)</h3>
          <p>Em breve: chat ao vivo via Typebot.</p>
          <div class="typebot-embed" style="height: 420px; background:#fff; border-radius:8px; display:flex; align-items:center; justify-content:center;">
            <span>Typebot aqui</span>
          </div>
        </div>
      </section>

      <!-- CLUBE -->
      <section id="clubSection" hidden>
        <div class="inner">
          <h3>CLUBE</h3>
          <p>Conecte-se com a comunidade e troque experi√™ncias. (em breve)</p>
        </div>
      </section>
    </main>
  </div>

  <!-- MODAL: Importar GPT -->
  <dialog id="importModal">
    <form id="importForm" method="dialog"
          class="import-form"
          data-table="user_gpts">
      <h3>Importar GPT</h3>

      <input type="hidden" name="user_id" value="" data-col="user_id" />

      <label>
        Link do GPT
        <input type="url" id="importLink" name="link" data-col="link" placeholder="https://chatgpt.com/g/..." required />
      </label>

      <label>
        Nome do GPT
        <input type="text" id="importName" name="name" data-col="name" placeholder="Meu GPT" required />
      </label>

      <label>
        Ferramentas (separe por v√≠rgula)
        <input type="text" id="importTools" name="tools" data-col="tools" placeholder="Browser, DALL¬∑E" />
      </label>

      <label>
        Prompt curto ideal
        <input type="text" id="importPrompt" name="prompt" data-col="prompt" placeholder="Descreva em 1 frase" />
      </label>

      <menu>
        <button id="importCloseBtn" value="cancel"  data-action="closeImport">Cancelar</button>
        <button id="importSaveBtn"  value="default" data-action="saveImport">Salvar</button>
      </menu>
    </form>
  </dialog>

  <!-- TOAST -->
  <div id="toast" class="toast" role="status" aria-live="polite" hidden></div>

  <!-- L√ìGICA -->
  <script src="js/app.js" defer></script>
</body>
</html>
